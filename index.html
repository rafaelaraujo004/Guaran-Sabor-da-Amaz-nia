<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Guaran√° da Amaz√¥nia ‚Äî POS (PWA)</title>
  <meta name="theme-color" content="#0b6e4f" />
  <!-- Manifest e Service Worker ser√£o criados dinamicamente para manter tudo em um √∫nico arquivo. -->
  <script src="script.js"></script>
  <link rel="stylesheet" href="style.css">
  <script src="jsPDF-loader.js"></script>
</head>
<body>
  <style>
      /* Evita overflow horizontal e vaza de tabela */
      .produtos-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        font-size: 15px;
        table-layout: auto;
        overflow-x: auto;
        display: block;
        max-width: 100%;
      }
      .produtos-table th, .produtos-table td {
        white-space: nowrap;
      }
      @media (max-width: 900px) {
        .produtos-table {
          display: block;
          overflow-x: auto;
          max-width: 100vw;
        }
      }
      @media (max-width: 600px) {
        .produtos-table {
          font-size: 13px;
        }
      }
    /* Oculta o status da impressora no topo */
    #printerStatus { display: none !important; }
  </style>
  <style>
    /* Oculta os cards de KPIs da parte superior */
    .kpi-mini { display: none !important; }
  </style>
  <header>
    <div class="wrap" style="display:flex;align-items:center;gap:16px">
      <div id="miniRelatorio" style="display:flex;gap:18px;align-items:center;margin-right:32px;">
        <div class="kpi-mini"><span>Receita</span><b id="miniKpiRevenue">R$¬†0,00</b></div>
        <div class="kpi-mini"><span>Vendas</span><b id="miniKpiSalesCount">0</b></div>
        <div class="kpi-mini"><span>Ticket M√©dio</span><b id="miniKpiAvg">R$¬†0,00</b></div>
      </div>
      <div class="brand">
  <!-- Logo removida -->
        <div>
          <h1>Guaran√° da Amaz√¥nia ‚Äî Gestor de Vendas</h1>
          <small>Simples, r√°pido, bonito ‚Äî com impress√£o Bluetooth</small>
        </div>
      </div>
      <div class="actions" style="margin-left:auto">
  <span id="printerStatus" class="pill warn" style="cursor:pointer;" title="Clique para conectar">üñ®Ô∏è Impressora: desconectada</span>
        <button id="btnInstall" class="btn secondary" hidden>Instalar App</button>
        <script>
        // Permitir conex√£o Bluetooth ao clicar no status da impressora
        document.addEventListener('DOMContentLoaded', function() {
          var printerStatus = document.getElementById('printerStatus');
          if (printerStatus) {
            printerStatus.addEventListener('click', function() {
              if (typeof connectPrinter === 'function') connectPrinter();
            });
          }
        });
        </script>
<script>
// Bot√µes de limpeza de dados
document.addEventListener('DOMContentLoaded', function() {
  const btnLimparDados = document.getElementById('btnLimparDados');
  const btnLimparProdutos = document.getElementById('btnLimparProdutos');
  if (btnLimparDados) {
    btnLimparDados.onclick = function() {
      if (confirm('Tem certeza que deseja apagar todos os dados do app (exceto produtos)? Esta a√ß√£o n√£o pode ser desfeita!')) {
        // Remove todas as chaves do localStorage, exceto products
        const produtos = localStorage.getItem('products');
        localStorage.clear();
        if (produtos) localStorage.setItem('products', produtos);
        alert('Dados apagados com sucesso!');
        location.reload();
      }
    };
  }
  if (btnLimparProdutos) {
    btnLimparProdutos.onclick = function() {
      if (confirm('Tem certeza que deseja apagar todos os produtos? Esta a√ß√£o n√£o pode ser desfeita!')) {
        localStorage.removeItem('products');
        alert('Produtos apagados com sucesso!');
        location.reload();
      }
    };
  }
});
</script>
      </div>
    </div>
    <div class="wrap" style="display:flex;justify-content:center;">
      <nav aria-label="Se√ß√µes" style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;width:100%;">
        <button data-route="vendas" aria-current="page">
          <span style="vertical-align:middle;display:inline-flex;align-items:center;gap:6px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="display:inline"><path d="M3 6h18M3 6v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6M3 6l2.293 2.293a1 1 0 0 0 1.414 0L12 3l5.293 5.293a1 1 0 0 0 1.414 0L21 6" stroke="#0b6e4f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Vendas (PDV)
          </span>
        </button>
        <button data-route="produtos">
          <span style="vertical-align:middle;display:inline-flex;align-items:center;gap:6px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 16V8a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2z" stroke="#0b6e4f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 10h18" stroke="#0b6e4f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Produtos & Estoque
          </span>
        </button>
        <button data-route="relatorios">
          <span style="vertical-align:middle;display:inline-flex;align-items:center;gap:6px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 3v18h18" stroke="#0b6e4f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><rect x="7" y="13" width="3" height="5" fill="#0b6e4f"/><rect x="12" y="9" width="3" height="9" fill="#0b6e4f"/><rect x="17" y="5" width="3" height="13" fill="#0b6e4f"/></svg>
            Relat√≥rios
          </span>
        </button>
        <button data-route="clientes">
          <span style="vertical-align:middle;display:inline-flex;align-items:center;gap:6px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="4" stroke="#0b6e4f" stroke-width="2"/><path d="M4 20c0-4 4-7 8-7s8 3 8 7" stroke="#0b6e4f" stroke-width="2"/></svg>
            Clientes
          </span>
        </button>
        <button data-route="config">
          <span style="vertical-align:middle;display:inline-flex;align-items:center;gap:6px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="3" stroke="#0b6e4f" stroke-width="2"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" stroke="#0b6e4f" stroke-width="2"/></svg>
            Configura√ß√µes
          </span>
        </button>
      </nav>
    </div>
  </header>

  <main>
    <!-- NOVO CAT√ÅLOGO VISUAL -->
    <section id="vendas" class="catalogo-section">
      <div class="catalogo-header">
        <h2>Cat√°logo de Produtos</h2>
        <input id="search" class="catalogo-search" placeholder="Buscar produto por nome ou SKU..." />
      </div>
      <div id="catalogoGrid" class="catalogo-grid-novo"></div>
      <div id="carrinhoNovo" class="carrinho-novo">
        <h3>üõí Carrinho</h3>
        <ul id="carrinhoLista"></ul>
        <div class="carrinho-resumo">
          <!-- Subtotal removido -->
          <span>Lucro estimado:</span> <b id="carrinhoLucro">R$ 0,00</b><br>
          <span>Total:</span> <b id="carrinhoTotal">R$ 0,00</b>
        </div>
        <div style="display:flex;align-items:center;gap:10px;margin-top:10px;">
          <div style="display:flex;flex-wrap:wrap;align-items:center;gap:8px;width:100%;">
            <label for="clienteCompra" style="font-size:14px;">Cliente:</label>
            <select id="clienteCompra" style="padding:4px 8px;border-radius:6px;border:1px solid #e3ebe8;min-width:120px;"></select>
            <button id="btnNovoCliente" type="button" class="btn-modern">Novo Cliente</button>
          </div>
        </div>
        <style>
          .kpi-mini {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            background: #f8faf9;
            border-radius: 8px;
            padding: 8px 16px;
            box-shadow: 0 1px 6px #0b6e4f11;
            border: 1.5px solid #e3ebe8;
            min-width: 90px;
            font-size: 13px;
            margin: 0 0 0 0;
          }
          .kpi-mini span { color: #0b6e4f; font-size: 12px; font-weight: 600; letter-spacing: 0.2px; }
          .kpi-mini b { font-size: 18px; margin: 2px 0; color: #1fc98e; font-weight: 800; letter-spacing: 0.5px; }
        </style>
<script>
// Atualiza mini relat√≥rio superior
function atualizarMiniRelatorio() {
  let vendas = [];
  try { vendas = JSON.parse(localStorage.getItem('sales')||'[]'); } catch {}
  let receita = 0, totalVendas = vendas.length, ticket = 0;
  vendas.forEach(v => { receita += v.total||0; });
  ticket = totalVendas ? receita/totalVendas : 0;
  if (document.getElementById('miniKpiRevenue')) document.getElementById('miniKpiRevenue').textContent = BRL.format(receita);
  if (document.getElementById('miniKpiSalesCount')) document.getElementById('miniKpiSalesCount').textContent = totalVendas;
  if (document.getElementById('miniKpiAvg')) document.getElementById('miniKpiAvg').textContent = BRL.format(ticket);
}
document.addEventListener('DOMContentLoaded', atualizarMiniRelatorio);
// Hook para atualizar junto com runReport
</script>
  </script>
          <input id="novoClienteNome" placeholder="Nome do cliente" style="padding:4px 8px;border-radius:6px;border:1px solid #e3ebe8;" />
          <input id="novoClienteDoc" placeholder="Documento (opcional)" style="padding:4px 8px;border-radius:6px;border:1px solid #e3ebe8;" />
          <button id="btnSalvarCliente" type="button" class="btn-modern" style="width:max-content;">Salvar Cliente</button>
        </div>
        <script>
        // Exibir formul√°rio de novo cliente
        document.getElementById('btnNovoCliente').onclick = function() {
          const form = document.getElementById('formNovoCliente');
          form.style.display = form.style.display === 'none' ? 'flex' : 'none';
        };
        // Salvar novo cliente
        document.getElementById('btnSalvarCliente').onclick = async function() {
          const nome = document.getElementById('novoClienteNome').value.trim();
          const doc = document.getElementById('novoClienteDoc').value.trim();
          if (!nome) return alert('Informe o nome do cliente!');
          const cliente = { id: 'cli_' + Math.random().toString(36).slice(2,9), name: nome, doc };
          let clientes = [];
          if (window.idb && window.openDB) {
            if (!window.db) window.db = await window.openDB();
            if (!window.idb) window.idb = idb;
            await window.idb.set('customers', cliente);
          } else {
            try { clientes = JSON.parse(localStorage.getItem('customers')||'[]'); } catch { clientes = []; }
            clientes = clientes.filter(c => c.id !== cliente.id);
            clientes.push(cliente);
            localStorage.setItem('customers', JSON.stringify(clientes));
          }
          document.getElementById('formNovoCliente').style.display = 'none';
          document.getElementById('novoClienteNome').value = '';
          document.getElementById('novoClienteDoc').value = '';
          if (typeof preencherClientesCompra === 'function') {
            await preencherClientesCompra();
            // Seleciona o novo cliente imediatamente ap√≥s atualizar o select
            const select = document.getElementById('clienteCompra');
            if (select) select.value = cliente.id;
          }
        };
        </script>
          <label for="tipoPagamento" style="font-size:14px;">Pagamento:</label>
          <select id="tipoPagamento" style="padding:4px 8px;border-radius:6px;border:1px solid #e3ebe8;">
            <option value="Dinheiro">Dinheiro</option>
            <option value="Pix">Pix</option>
            <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
            <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
            <option value="Outros">Outros</option>
          </select>
          <button id="btnFinalizarCompra" class="btn-modern" style="margin-left:10px;">Finalizar venda</button>
        </div>
      </div>
    </section>
    <style>
      .catalogo-section { display: flex; flex-direction: column; gap: 24px; }
      .catalogo-header { display: flex; flex-wrap: wrap; align-items: center; gap: 16px; justify-content: space-between; }
      .catalogo-search { flex: 1; max-width: 320px; padding: 8px; border-radius: 8px; border: 1px solid #e3ebe8; }
      .catalogo-grid-novo { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 18px; }
      .catalogo-produto-card {
        background: linear-gradient(135deg, #f8faf9 60%, #e3ebe8 100%);
        border-radius: 14px;
        box-shadow: 0 2px 12px rgba(11,110,79,.10);
        padding: 18px 12px 16px 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        transition: box-shadow .2s, transform .2s;
        border: 1.5px solid #e3ebe8;
      }
      .catalogo-produto-card:hover {
        box-shadow: 0 6px 24px rgba(11,110,79,.18);
        transform: translateY(-2px) scale(1.03);
        border-color: #0b6e4f33;
      }
      .catalogo-produto-card img {
        width: 70px; height: 70px; object-fit: cover; border-radius: 10px; background: #f6f8f7; border: 2px solid #e3ebe8;
      }
      .catalogo-produto-card .nome {
        font-weight: 700; font-size: 16px; text-align: center; color: #0b6e4f;
      }
      .catalogo-produto-card .preco {
        color: #0b6e4f; font-weight: 800; font-size: 16px; letter-spacing: 0.5px;
      }
      .catalogo-produto-card .estoque {
        font-size: 13px; color: #888; margin-bottom: 2px;
      }
      .catalogo-produto-card .btn {
        margin-top: 6px;
        background: linear-gradient(90deg, #0b6e4f 60%, #1fc98e 100%);
        color: #fff;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        padding: 7px 18px;
        font-size: 15px;
        box-shadow: 0 1px 4px #0b6e4f22;
        transition: background .2s, box-shadow .2s;
      }
      .catalogo-produto-card .btn:hover {
  background: linear-gradient(90deg, #1fc98e 10%, #0b6e4f 90%);
        box-shadow: 0 2px 8px #0b6e4f33;
      }
      .carrinho-novo {
        background: linear-gradient(135deg, #f8faf9 70%, #e3ebe8 100%);
        border-radius: 14px;
        padding: 22px 18px;
        margin-top: 24px;
        max-width: 420px;
        box-shadow: 0 2px 12px rgba(11,110,79,.08);
        border: 1.5px solid #e3ebe8;
      }
      .carrinho-novo h3 { margin-top: 0; }
      .carrinho-novo ul { list-style: none; padding: 0; margin: 0 0 12px 0; }
      .carrinho-novo li { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e3ebe8; font-size: 15px; }
      .carrinho-novo li:last-child { border-bottom: none; }
      .carrinho-resumo { margin: 14px 0; font-size: 16px; font-weight: 500; color: #0b6e4f; }
      .kpi {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        background: linear-gradient(90deg, #f8faf9 70%, #e3ebe8 100%);
        border-radius: 12px;
        padding: 14px 22px;
        margin-bottom: 10px;
        box-shadow: 0 1px 6px #0b6e4f11;
        border: 1.5px solid #e3ebe8;
        min-width: 140px;
      }
      .kpi span { color: #0b6e4f; font-size: 13px; font-weight: 600; letter-spacing: 0.2px; }
      .kpi b { font-size: 22px; margin: 2px 0; color: #1fc98e; font-weight: 800; letter-spacing: 0.5px; }
      .kpi small { color: #888; font-size: 13px; font-weight: 500; }
      .produtos-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 15px; }
      .produtos-table th, .produtos-table td { padding: 7px 10px; border-bottom: 1px solid #e3ebe8; text-align: left; transition: background .15s; }
      .produtos-table th { background: #f8faf9; font-weight: 700; color: #0b6e4f; }
      .produtos-table tbody tr:hover { background: #e3ebe8; }
    </style>
    <script>
  // Cat√°logo visual
      async function renderNovoCatalogo() {
        const grid = document.getElementById('catalogoGrid');
        if (!grid) return;
        grid.innerHTML = '';
        let produtos = [];
        if (window.idb && window.openDB) {
          if (!window.db) window.db = await window.openDB();
          produtos = await window.idb.all('products');
        } else {
          try { produtos = JSON.parse(localStorage.getItem('products')||'[]'); } catch { produtos = []; }
        }
        if (!produtos.length) {
          grid.innerHTML = '<p style="color:var(--muted);text-align:center;margin:32px 0;">Nenhum produto cadastrado.</p>';
          return;
        }
        produtos.forEach(produto => {
          const card = document.createElement('div');
          card.className = 'catalogo-produto-card';
          let imgSrc = produto.image || produto.img || 'https://cdn-icons-png.flaticon.com/512/1046/1046857.png';
          card.innerHTML = `
            <img src="${imgSrc}" alt="">
            <div class="nome">${produto.name}</div>
            <div class="estoque">${produto.stock||0} un.</div>
            <div class="preco">${BRL.format(produto.price)}</div>
            <button class='btn' ${produto.stock>0?'':'disabled'}>Adicionar</button>
          `;
          card.querySelector('button').onclick = () => addProdutoCarrinho(produto);
          grid.appendChild(card);
        });
      }

      // Carrinho simples com persist√™ncia
      const CARRINHO_KEY = 'cart_items';
      let carrinho = [];
      // Carrega carrinho salvo ao iniciar
      try {
        carrinho = JSON.parse(localStorage.getItem(CARRINHO_KEY) || '[]');
      } catch { carrinho = []; }

      function salvarCarrinho() {
        localStorage.setItem(CARRINHO_KEY, JSON.stringify(carrinho));
      }

      function addProdutoCarrinho(produto) {
        const idx = carrinho.findIndex(p=>p.sku===produto.sku);
        if (idx>-1) carrinho[idx].qty++;
        else carrinho.push({...produto, qty:1});
        salvarCarrinho();
        // Reduz estoque do produto ao adicionar
        atualizarEstoqueProduto(produto.sku, -1).then(renderNovoCatalogo);
        renderCarrinhoNovo();
      }

      // Fun√ß√£o para atualizar o estoque do produto
      async function atualizarEstoqueProduto(sku, delta) {
        let produtos = [];
        if (window.idb && window.openDB) {
          if (!window.db) window.db = await window.openDB();
          produtos = await window.idb.all('products');
        } else {
          try { produtos = JSON.parse(localStorage.getItem('products')||'[]'); } catch { produtos = []; }
        }
        const idx = produtos.findIndex(p => p.sku === sku);
        if (idx > -1) {
          produtos[idx].stock = Math.max(0, (produtos[idx].stock||0) + delta);
          if (window.idb && window.openDB) {
            await window.idb.set('products', produtos[idx]);
          } else {
            localStorage.setItem('products', JSON.stringify(produtos));
          }
        }
      }

      function renderCarrinhoNovo() {
        const ul = document.getElementById('carrinhoLista');
        ul.innerHTML = '';
        let subtotal = 0;
        let lucro = 0;
        carrinho.forEach((item, idx) => {
          subtotal += (item.price||0) * (item.qty||1);
          lucro += ((item.price||0) - (item.cost||0)) * (item.qty||1);
          const li = document.createElement('li');
          li.innerHTML = `<span>${item.name} <small>x${item.qty}</small></span><b>${BRL.format(item.price*item.qty)}</b> <button class='btn danger btn-remover-item' data-idx='${idx}' title='Remover item' style='margin-left:10px;padding:2px 8px;font-size:13px;'>‚úñ</button>`;
          ul.appendChild(li);
        });
        // Adiciona evento para remover item
        setTimeout(() => {
          document.querySelectorAll('.btn-remover-item').forEach(btn => {
            btn.onclick = function() {
              const idx = parseInt(this.getAttribute('data-idx'));
              if (!isNaN(idx)) {
                carrinho.splice(idx, 1);
                salvarCarrinho();
                renderCarrinhoNovo();
              }
            };
          });
        }, 10);
        document.getElementById('carrinhoLucro').textContent = BRL.format(lucro);
        document.getElementById('carrinhoTotal').textContent = BRL.format(subtotal);
      }
      document.addEventListener('DOMContentLoaded', renderNovoCatalogo);
      document.getElementById('search').addEventListener('input', function(e) {
        const termo = e.target.value.toLowerCase();
        const cards = document.querySelectorAll('.catalogo-produto-card');
        cards.forEach(card => {
          const nome = card.querySelector('.nome').textContent.toLowerCase();
          card.style.display = nome.includes(termo) ? '' : 'none';
        });
      });

      // Gera√ß√£o de cupom em PDF ao finalizar compra
      document.getElementById('btnFinalizarCompra').onclick = async function() {

        if (!carrinho.length) return alert('Adicione produtos ao carrinho!');
        const tipoPagamento = document.getElementById('tipoPagamento').value;
        const clienteSelect = document.getElementById('clienteCompra');
        const clienteId = clienteSelect && clienteSelect.value ? clienteSelect.value : null;
        const clienteNome = clienteSelect && clienteSelect.value ? clienteSelect.options[clienteSelect.selectedIndex].text : '';

        // Salvar venda no localStorage
        let venda;
        try {
          // Calcula totais
          let subtotal = 0;
          let lucroBruto = 0;
          carrinho.forEach(item => {
            subtotal += (item.price||0) * (item.qty||1);
            lucroBruto += ((item.price||0)-(item.cost||0)) * (item.qty||1);
          });
          venda = {
            id: 'sale_' + Math.random().toString(36).slice(2,9),
            at: Date.now(),
            items: carrinho.map(i => ({...i})),
            subtotal,
            discount: 0,
            taxes: 0,
            total: subtotal,
            profit: lucroBruto,
            payment: tipoPagamento,
            customerId: clienteId,
            customerName: clienteNome
          };
          let vendas = [];
          try { vendas = JSON.parse(localStorage.getItem('sales')||'[]'); } catch {}
          vendas.push(venda);
          localStorage.setItem('sales', JSON.stringify(vendas));
        } catch (e) {
          alert('Erro ao salvar venda: ' + (e.message||e));
          return;
        }

        // Aguarda jsPDF carregar corretamente
        function gerarCupomPDF() {
          let jsPDFref = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : (window.jsPDF ? window.jsPDF : null);
          if (!jsPDFref) {
            alert('Erro ao carregar o m√≥dulo de PDF. Tente novamente em alguns segundos.');
            return;
          }
          const doc = new jsPDFref();
          let y = 15;
          doc.setFontSize(18);
          doc.text('Guaran√° Sabor da Amaz√¥nia', 105, y, { align: 'center' });
          y += 10;
          doc.setFontSize(15);
          doc.text('Cupom de Venda', 105, y, { align: 'center' });
          y += 10;
          doc.setFontSize(11);
          doc.text('Data: ' + new Date().toLocaleString('pt-BR'), 15, y);
          y += 8;
          if (clienteNome) {
            doc.text('Cliente: ' + clienteNome, 15, y);
            y += 8;
          }
          doc.text('Itens:', 15, y);
          y += 7;
          carrinho.forEach(item => {
            doc.text(`${item.name} x${item.qty} - ${BRL.format(item.price*item.qty)}`, 18, y);
            y += 7;
          });
          y += 4;
          doc.setFontSize(12);
          doc.text('Total: ' + BRL.format(venda.total), 15, y);
          y += 8;
          doc.setFontSize(11);
          doc.text('Pagamento: ' + tipoPagamento, 15, y);
          y += 10;
          doc.setFontSize(10);
          doc.text('Obrigado pela prefer√™ncia!', 105, y, { align: 'center' });
          doc.save('cupom-venda.pdf');
        }
        // Se jsPDF ainda n√£o carregou, aguarda e tenta de novo
        if (!window.jspdf || !(window.jspdf.jsPDF || window.jsPDF)) {
          alert('Carregando m√≥dulo de PDF, aguarde alguns segundos e clique novamente em Finalizar compra.');
          return;
        }
        gerarCupomPDF();
        // Limpa carrinho
        carrinho = [];
        renderCarrinhoNovo();
        // Atualiza relat√≥rios se fun√ß√£o global existir
        if (typeof runReport === 'function') runReport();
      };
      // Preencher o select de clientes ao carregar a p√°gina
      async function preencherClientesCompra() {
        const select = document.getElementById('clienteCompra');
        if (!select) return;
        let clientes = [];
          try {
            if (window.idb && window.openDB && typeof window.idb.all === 'function') {
              if (!window.db) window.db = await window.openDB();
              clientes = await window.idb.all('customers');
            } else {
              clientes = JSON.parse(localStorage.getItem('customers')||'[]');
            }
          } catch (e) {
            clientes = [];
          }
          select.innerHTML = '<option value="">(Nenhum)</option>';
          (clientes||[]).forEach(c => {
            if (c && c.id && c.name) {
              const opt = document.createElement('option');
              opt.value = c.id;
              opt.textContent = c.name;
              select.appendChild(opt);
            }
          });
      }
      document.addEventListener('DOMContentLoaded', preencherClientesCompra);
        // Atualizar select de clientes ap√≥s cadastro de novo cliente
        window.atualizarClientesCompra = preencherClientesCompra;
    </script>
<script>
// Fun√ß√£o para salvar produto (IndexedDB ou localStorage)
document.addEventListener('DOMContentLoaded', function() {
  const btnSaveProduct = document.getElementById('btnSaveProduct');
  if (btnSaveProduct) {
    btnSaveProduct.onclick = async function() {
      const name = document.getElementById('pName').value.trim();
      const sku = document.getElementById('pSku').value.trim();
      const price = parseFloat(document.getElementById('pPrice').value) || 0;
      const cost = parseFloat(document.getElementById('pCost').value) || 0;
      const stock = parseInt(document.getElementById('pStock').value) || 0;
      const category = document.getElementById('pCategory').value.trim();
      let image = null;
      const fileInput = document.getElementById('pImage');
      if (fileInput && fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        image = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }
      if (!name || !sku) return alert('Preencha nome e SKU!');
      const produto = { id: sku, name, sku, price, cost, stock, category, image };
      try {
        if (window.idb && window.openDB) {
          if (!window.db) {
            window.db = await window.openDB();
          }
          // Garante que window.idb est√° dispon√≠vel (caso scripts externos)
          if (!window.idb) {
            window.idb = window.db ? window.idb : null;
          }
          if (!window.idb) throw new Error('IndexedDB n√£o dispon√≠vel.');
          await window.idb.set('products', produto);
        } else {
          // Fallback: salva em localStorage
          let produtos = [];
          try {
            produtos = JSON.parse(localStorage.getItem('products')||'[]');
          } catch {}
          const idx = produtos.findIndex(p=>p.id===sku);
          if (idx>-1) produtos[idx] = produto;
          else produtos.push(produto);
          localStorage.setItem('products', JSON.stringify(produtos));
        }
        alert('Produto salvo com sucesso!');
        if (typeof renderCatalogo === 'function') renderCatalogo();
      } catch (e) {
        alert('Erro ao salvar produto: ' + (e.message||e));
      }
    };
  }
});

// Fun√ß√£o para salvar cliente
document.addEventListener('DOMContentLoaded', function() {
  const btnSaveCustomer = document.getElementById('btnSaveCustomer');
  if (btnSaveCustomer) {
    btnSaveCustomer.onclick = async function() {
      const name = document.getElementById('cName').value.trim();
      const phone = document.getElementById('cPhone').value.trim();
      const email = document.getElementById('cEmail').value.trim();
      const doc = document.getElementById('cDoc').value.trim();
      if (!name) return alert('Preencha o nome do cliente!');
      const cliente = { id: Date.now().toString(), name, phone, email, doc };
      try {
        if (window.idb && window.db) {
          await window.idb.set('customers', cliente);
        }
        alert('Cliente salvo com sucesso!');
      } catch (e) {
        alert('Erro ao salvar cliente: ' + (e.message||e));
      }
    };
  }
});
// Fun√ß√£o moderna e centralizada para conectar impressora Bluetooth
function conectarImpressoraBluetooth(printerStatus) {
  if (!navigator.bluetooth) {
    alert('Web Bluetooth n√£o suportado neste dispositivo. Use o modo de impress√£o do sistema.');
    return;
  }
  if (!printerStatus || printerStatus._isConnecting) return;
  printerStatus._isConnecting = true;
  printerStatus.textContent = 'üñ®Ô∏è Procurando dispositivos Bluetooth...';
  printerStatus.classList.remove('warn','success');
  printerStatus.classList.add('info');
  // Cria modal de sele√ß√£o
  let modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;';
  let box = document.createElement('div');
  box.style.cssText = 'background:#fff;padding:24px 18px;border-radius:12px;min-width:320px;max-width:95vw;max-height:80vh;overflow:auto;box-shadow:0 8px 32px rgba(0,0,0,.18);';
  box.innerHTML = '<h3 style="margin-top:0">Selecione um dispositivo Bluetooth</h3><div id="btList" style="margin:12px 0 0 0;min-height:40px">Buscando...</div><button id="btCancel" class="btn danger" style="margin-top:18px;width:100%">Cancelar</button>';
  modal.appendChild(box);
  document.body.appendChild(modal);
  const btList = box.querySelector('#btList');
  const btCancel = box.querySelector('#btCancel');
  btCancel.onclick = () => { document.body.removeChild(modal); printerStatus._isConnecting = false; printerStatus.textContent = 'üñ®Ô∏è Impressora: desconectada'; printerStatus.classList.remove('info','success'); printerStatus.classList.add('warn'); };
  (async () => {
    try {
      // Solicita dispositivo BLE (todos)
      const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [0xFFE0, 0xFF02, 0xFF01, 0x1812, 0x180F, 'device_information']
      });
      btList.innerHTML = '';
      // Mostra o dispositivo encontrado
      let item = document.createElement('div');
      item.className = 'bt-device-item';
      item.style.cssText = 'padding:10px 8px;border:1px solid #eee;border-radius:7px;margin-bottom:8px;cursor:pointer;';
      item.innerHTML = `<b>${device.name || '(sem nome)'}</b><br><small>ID: ${device.id}</small>`;
      item.onclick = async () => {
        btList.innerHTML = 'Conectando...';
        try {
          let server = await device.gatt.connect();
          let service = null, characteristic = null;
          const services = await server.getPrimaryServices();
          for (let s of services) {
            try {
              const chars = await s.getCharacteristics();
              for (let c of chars) {
                if (c.properties.write) {
                  service = s; characteristic = c; break;
                }
              }
              if (characteristic) break;
            } catch {}
          }
          if (!characteristic) throw new Error('Impressora n√£o suportada ou n√£o encontrada.');
          printerStatus.textContent = 'üñ®Ô∏è Impressora: conectada';
          printerStatus.classList.remove('warn','info');
          printerStatus.classList.add('success');
          window.bluetoothPrinter = { device, server, service, characteristic };
          if (window.appFeedback) window.appFeedback('Impressora conectada com sucesso!');
          document.body.removeChild(modal);
          device.addEventListener('gattserverdisconnected', function() {
            printerStatus.textContent = 'üñ®Ô∏è Impressora: desconectada';
            printerStatus.classList.remove('success','info');
            printerStatus.classList.add('warn');
            if (window.appFeedback) window.appFeedback('Impressora desconectada. Clique para reconectar.');
          });
        } catch (e) {
          btList.innerHTML = '<span style="color:#c00">Erro ao conectar: ' + (e.message||e) + '</span>';
        } finally {
          printerStatus._isConnecting = false;
        }
      };
      btList.appendChild(item);
    } catch (e) {
      btList.innerHTML = '<span style="color:#c00">Nenhum dispositivo encontrado ou opera√ß√£o cancelada.</span>';
      printerStatus.textContent = 'üñ®Ô∏è Impressora: desconectada';
      printerStatus.classList.remove('success','info');
      printerStatus.classList.add('warn');
      if (window.appFeedback) window.appFeedback('Nenhum dispositivo encontrado.');
    } finally {
      printerStatus._isConnecting = false;
    }
  })();
}
// Bot√£o do topo
document.addEventListener('DOMContentLoaded', function() {
  const printerStatus = document.getElementById('printerStatus');
  if (printerStatus) {
    printerStatus.addEventListener('click', function() { conectarImpressoraBluetooth(printerStatus); });
  }
  // Bot√£o da tela de configura√ß√µes
  const btnConnectPrinter2 = document.getElementById('btnConnectPrinter2');
  if (btnConnectPrinter2) {
    btnConnectPrinter2.addEventListener('click', function() {
      const printerStatus = document.getElementById('printerStatus');
      conectarImpressoraBluetooth(printerStatus);
    });
  }
});
// Carrinho moderno
let cart = [];
const BRL = new Intl.NumberFormat('pt-BR', {style:'currency', currency:'BRL'});
function renderCart() {
  const ul = document.getElementById('cartList');
  const empty = document.getElementById('cartEmpty');
  const resumo = document.getElementById('cartResumo');
  if (!ul || !empty || !resumo) return;
  ul.innerHTML = '';
  if (!cart.length) {
    empty.style.display = '';
    resumo.style.display = 'none';
  } else {
    empty.style.display = 'none';
    resumo.style.display = '';
    cart.forEach((item, idx) => {
      const li = document.createElement('li');
      li.style = 'display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #e3ebe8;gap:10px;min-height:60px;';
      li.innerHTML = `
        <div style='display:flex;align-items:center;gap:10px;flex:1;'>
          <div style='width:44px;height:44px;background:#f6f8f7;border-radius:8px;display:flex;align-items:center;justify-content:center;'>
            <img src="${item.img||'https://cdn-icons-png.flaticon.com/512/1046/1046857.png'}" alt="" style="width:36px;height:36px;object-fit:cover;border-radius:6px;">
          </div>
          <div style='flex:1;'>
            <div style='font-weight:600;font-size:15px;'>${item.name}</div>
            <div style='color:var(--muted);font-size:13px;'>SKU: ${item.sku||'-'} | Qtd: <input type='number' min='1' value='${item.qty}' style='width:48px;text-align:right;border-radius:8px;border:1px solid #e3ebe8;padding:2px 6px;'> x ${BRL.format(item.price)}</div>
          </div>
        </div>
        <div style='text-align:right;'>
          <div style='font-weight:700;font-size:15px;'>${BRL.format(item.price*item.qty)}</div>
          <button class='btn danger' style='font-size:15px;padding:4px 10px;margin-top:4px;' title='Remover'>&times;</button>
        </div>
      `;
      li.querySelector('button').onclick = () => { cart.splice(idx,1); renderCart(); };
      li.querySelector('input').onchange = (e) => {
        let v = Math.max(1, parseInt(e.target.value)||1);
        cart[idx].qty = v;
        renderCart();
      };
      ul.appendChild(li);
    });
  }
  // Resumo
  let subtotal = cart.reduce((s,x)=>s+x.price*x.qty,0);
  let desconto = 0;
  let total = subtotal - desconto;
  document.getElementById('cartSubtotal').textContent = BRL.format(subtotal);
  document.getElementById('cartDesconto').textContent = BRL.format(desconto);
  document.getElementById('cartTotal').textContent = BRL.format(total);
}
// Adicionar ao carrinho (exemplo: chame esta fun√ß√£o ao clicar em produto)
window.addToCart = function(produto) {
  let idx = cart.findIndex(x=>x.id===produto.id);
  if (idx>-1) { cart[idx].qty++; } else { cart.push({...produto, qty:1}); }
  renderCart();
}
// Exemplo de integra√ß√£o: clique em produto do cat√°logo
document.addEventListener('DOMContentLoaded', function() {
  const lista = document.getElementById('listaProdutos');
  if (lista) {
    lista.addEventListener('click', function(e) {
      const card = e.target.closest('.card');
      if (card && card.dataset && card.dataset.produto) {
        const produto = JSON.parse(card.dataset.produto);
        window.addToCart(produto);
      }
    });
  }
  renderCart();
  // Finalizar compra
  const btnFinalizar = document.getElementById('btnFinalizarNovo');
  if (btnFinalizar) btnFinalizar.onclick = function() {
    if (!cart.length) return alert('Adicione produtos ao carrinho!');
    alert('Compra finalizada! (implemente a l√≥gica de venda aqui)');
    cart = [];
    renderCart();
  };
});
</script>
    </section>

    <!-- NOVO CADASTRO DE PRODUTOS -->
    <section id="produtos" hidden class="cadastro-produto-section">
      <div class="cadastro-produto-card">
        <h2>Cadastrar Produto</h2>
        <form id="formProduto" autocomplete="off">
          <div class="form-row">
            <label>Nome</label>
            <input id="pName" required placeholder="Ex.: Guaran√° Original 1L">
          </div>
          <div class="form-row">
            <label>SKU</label>
            <input id="pSku" required placeholder="C√≥digo interno">
          </div>
          <div class="form-row">
            <label>Pre√ßo de venda (R$)</label>
            <input type="number" step="0.01" id="pPrice" required min="0" value="0">
          </div>
          <div class="form-row">
            <label>Custo do produto (R$)</label>
            <input type="number" step="0.01" id="pCost" required min="0" value="0">
          </div>
          <div class="form-row">
            <label>Estoque</label>
            <input type="number" id="pStock" required min="0" value="0">
          </div>
          <div class="form-row">
            <label>Categoria</label>
            <input id="pCategory" placeholder="Bebidas, Comidas‚Ä¶">
          </div>
          <div class="form-row">
            <label>Foto do produto</label>
            <input id="pImage" type="file" accept="image/*">
            <img id="pImagePreview" style="display:none;margin-top:8px;max-width:120px;max-height:120px;object-fit:contain;border:1px solid #eee;border-radius:8px;" />
          </div>
          <div class="form-actions">
            <button id="btnSaveProduct" class="btn" type="submit">Salvar</button>
            <button id="btnNewProduct" class="btn secondary" type="button">Novo</button>
          </div>
        </form>
      </div>
      <div class="lista-produtos-card">
        <h3>Lista de Produtos</h3>
        <input id="filterProducts" placeholder="Filtrar por nome ou SKU..." />
        <table class="produtos-table">
          <thead><tr><th>SKU</th><th>Nome</th><th></th><th>Pre√ßo</th><th>Estoque</th></tr></thead>
          <tbody id="productsBody"></tbody>
        </table>
      </div>
    </section>
    <style>
      .cadastro-produto-section { display: flex; flex-wrap: wrap; gap: 32px; }
      .cadastro-produto-card, .lista-produtos-card { background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(11,110,79,.07); padding: 24px; min-width: 320px; max-width: 420px; flex: 1; }
      .cadastro-produto-card h2, .lista-produtos-card h3 { margin-top: 0; }
      .form-row { display: flex; flex-direction: column; gap: 4px; margin-bottom: 14px; }
      .form-actions { display: flex; gap: 12px; margin-top: 10px; }
      .produtos-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 15px; }
      .produtos-table th, .produtos-table td { padding: 7px 10px; border-bottom: 1px solid #e3ebe8; text-align: left; }
      .produtos-table th { background: #f8faf9; font-weight: 700; color: #0b6e4f; }
      .produtos-table tbody tr:hover { background: #e3ebe8; }
    </style>
    <script>
      // Preview da imagem
      document.getElementById('pImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('pImagePreview');
        if (file) {
          const reader = new FileReader();
          reader.onload = ev => { preview.src = ev.target.result; preview.style.display = 'block'; };
          reader.readAsDataURL(file);
        } else {
          preview.style.display = 'none';
        }
      });
      // Salvar produto
      document.getElementById('formProduto').onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById('pName').value.trim();
        const sku = document.getElementById('pSku').value.trim();
        const price = parseFloat(document.getElementById('pPrice').value) || 0;
        const cost = parseFloat(document.getElementById('pCost').value) || 0;
        const stock = parseInt(document.getElementById('pStock').value) || 0;
        const category = document.getElementById('pCategory').value.trim();
        let image = null;
        const fileInput = document.getElementById('pImage');
        if (fileInput && fileInput.files && fileInput.files[0]) {
          const file = fileInput.files[0];
          image = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = e => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        }
        if (!name || !sku) return alert('Preencha nome e SKU!');
        const produto = { id: sku, name, sku, price, cost, stock, category, image };
        try {
          if (window.idb && window.openDB) {
            if (!window.db) window.db = await window.openDB();
            await window.idb.set('products', produto);
          } else {
            let produtos = [];
            try { produtos = JSON.parse(localStorage.getItem('products')||'[]'); } catch {}
            const idx = produtos.findIndex(p=>p.id===sku);
            if (idx>-1) produtos[idx] = produto;
            else produtos.push(produto);
            localStorage.setItem('products', JSON.stringify(produtos));
          }
          alert('Produto salvo com sucesso!');
          renderNovoCatalogo();
          renderListaProdutos();
        } catch (e) {
          alert('Erro ao salvar produto: ' + (e.message||e));
        }
      };
      // Limpar formul√°rio
      document.getElementById('btnNewProduct').onclick = function() {
        document.getElementById('formProduto').reset();
        document.getElementById('pImagePreview').style.display = 'none';
      };
      // Renderizar lista de produtos
      async function renderListaProdutos() {
        const tbody = document.getElementById('productsBody');
        tbody.innerHTML = '';
        let produtos = [];
        if (window.idb && window.openDB) {
          if (!window.db) window.db = await window.openDB();
          produtos = await window.idb.all('products');
        } else {
          try { produtos = JSON.parse(localStorage.getItem('products')||'[]'); } catch { produtos = []; }
        }
        if (!produtos.length) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:18px 0;">Nenhum produto cadastrado.</td></tr>';
          return;
        }
        produtos.forEach(produto => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${produto.sku}</td>
            <td>${produto.name}</td>
            <td><button class='btn secondary' style='margin-right:8px' onclick='editarProduto("${produto.sku}")'>Editar</button></td>
            <td>${BRL.format(produto.price)}</td>
            <td>${produto.stock||0}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      // Editar produto
      window.editarProduto = async function(sku) {
        let produtos = [];
        if (window.idb && window.openDB) {
          if (!window.db) window.db = await window.openDB();
          produtos = await window.idb.all('products');
        } else {
          try { produtos = JSON.parse(localStorage.getItem('products')||'[]'); } catch { produtos = []; }
        }
        const produto = produtos.find(p=>p.sku===sku);
        if (!produto) return;
        document.getElementById('pName').value = produto.name;
        document.getElementById('pSku').value = produto.sku;
        document.getElementById('pPrice').value = produto.price;
        document.getElementById('pStock').value = produto.stock;
        document.getElementById('pCategory').value = produto.category||'';
        if (produto.image) {
          document.getElementById('pImagePreview').src = produto.image;
          document.getElementById('pImagePreview').style.display = 'block';
        } else {
          document.getElementById('pImagePreview').style.display = 'none';
        }
      };
      document.addEventListener('DOMContentLoaded', renderListaProdutos);
      document.getElementById('filterProducts').addEventListener('input', function(e) {
        const termo = e.target.value.toLowerCase();
        const trs = document.querySelectorAll('.produtos-table tbody tr');
        trs.forEach(tr => {
          const nome = tr.children[1].textContent.toLowerCase();
          const sku = tr.children[0].textContent.toLowerCase();
          tr.style.display = nome.includes(termo) || sku.includes(termo) ? '' : 'none';
        });
      });
    </script>

    <!-- Relat√≥rios -->
    <section id="relatorios" hidden class="grid cols-2">
      <div class="card">
        <div class="head"><strong>Vis√£o geral</strong></div>
        <div class="body grid cols-4">
          <div class="kpi"><span>Receita</span><b id="kpiRevenue">R$¬†0,00</b></div>
          <div class="kpi"><span>Vendas</span><b id="kpiSalesCount">0</b></div>
          <div class="kpi"><span>Ticket m√©dio</span><b id="kpiAvg">R$¬†0,00</b></div>
          <div class="kpi"><span>Lucro</span><b id="kpiProfit">R$¬†0,00</b></div>
        </div>
        <div class="toolbar" style="margin: 18px 0 0 0; gap: 12px; flex-wrap: wrap; display: flex; align-items: flex-end;">
          <div>
            <label for="filtroDataIni">Data inicial:</label>
            <input type="date" id="filtroDataIni" style="padding:4px 8px;border-radius:6px;border:1px solid #e3ebe8;">
          </div>
          <div>
            <label for="filtroDataFim">Data final:</label>
            <input type="date" id="filtroDataFim" style="padding:4px 8px;border-radius:6px;border:1px solid #e3ebe8;">
          </div>
          <div>
            <label for="filtroProduto">Produto:</label>
            <select id="filtroProduto" style="padding:4px 8px;border-radius:6px;border:1px solid #e3ebe8;min-width:120px;">
              <option value="">Todos</option>
            </select>
          </div>
          <button id="btnAplicarFiltros" class="btn secondary">Filtrar</button>
        </div>
      </div>
<script>
// Atualiza KPIs da se√ß√£o de relat√≥rios com filtros
async function atualizarKPIRelatoriosComFiltro() {
  let vendas = [];
  try { vendas = JSON.parse(localStorage.getItem('sales')||'[]'); } catch {}
  let produtos = [];
  try { produtos = JSON.parse(localStorage.getItem('products')||'[]'); } catch {}
  const mapCusto = {};
  produtos.forEach(p => { mapCusto[p.sku||p.id] = typeof p.cost === 'number' ? p.cost : (typeof p.custo === 'number' ? p.custo : 0); });

  // Filtros
  const dataIni = document.getElementById('filtroDataIni').value;
  const dataFim = document.getElementById('filtroDataFim').value;
  const produtoSel = document.getElementById('filtroProduto').value;

  let receita = 0, totalVendas = 0, ticket = 0, lucro = 0;
  let vendasFiltradas = vendas.filter(v => {
    let ok = true;
    if (dataIni) {
      const dataVenda = new Date(v.at || v.data || v.date || v.createdAt);
      ok = ok && dataVenda >= new Date(dataIni + 'T00:00:00');
    }
    if (dataFim) {
      const dataVenda = new Date(v.at || v.data || v.date || v.createdAt);
      ok = ok && dataVenda <= new Date(dataFim + 'T23:59:59');
    }
    if (produtoSel) {
      if (!v.items || !Array.isArray(v.items)) return false;
      ok = ok && v.items.some(item => (item.sku || item.id) == produtoSel);
    }
    return ok;
  });
  totalVendas = vendasFiltradas.length;
  vendasFiltradas.forEach(v => {
    receita += v.total||0;
    if (typeof v.profit === 'number') {
      lucro += v.profit;
    } else if (v.items && Array.isArray(v.items)) {
      v.items.forEach(item => {
        if (produtoSel && (item.sku || item.id) != produtoSel) return;
        const sku = item.sku || item.id;
        const precoVenda = item.price || item.precoVenda || 0;
        const qtd = item.qty || item.qtd || 1;
        const precoCusto = (typeof item.cost === 'number') ? item.cost : (typeof item.precoCusto === 'number' ? item.precoCusto : mapCusto[sku] || 0);
        if (precoVenda > 0 && precoCusto >= 0) {
          lucro += (precoVenda - precoCusto) * qtd;
        }
      });
    }
  });
  ticket = totalVendas ? receita/totalVendas : 0;
  if (document.getElementById('kpiRevenue')) document.getElementById('kpiRevenue').textContent = BRL.format(receita);
  if (document.getElementById('kpiSalesCount')) document.getElementById('kpiSalesCount').textContent = totalVendas;
  if (document.getElementById('kpiAvg')) document.getElementById('kpiAvg').textContent = BRL.format(ticket);
  if (document.getElementById('kpiProfit')) document.getElementById('kpiProfit').textContent = BRL.format(lucro);
}
document.addEventListener('DOMContentLoaded', function() {
  // Preenche produtos no filtro
  let produtos = [];
  try { produtos = JSON.parse(localStorage.getItem('products')||'[]'); } catch {}
  const select = document.getElementById('filtroProduto');
  if (select && produtos.length) {
    produtos.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.sku || p.id;
      opt.textContent = p.name;
      select.appendChild(opt);
    });
  }
  atualizarKPIRelatoriosComFiltro();
  document.getElementById('btnAplicarFiltros').onclick = atualizarKPIRelatoriosComFiltro;
  document.getElementById('filtroDataIni').onchange = atualizarKPIRelatoriosComFiltro;
  document.getElementById('filtroDataFim').onchange = atualizarKPIRelatoriosComFiltro;
  document.getElementById('filtroProduto').onchange = atualizarKPIRelatoriosComFiltro;
});
// Hook para atualizar junto com runReport
const oldRunReport = window.runReport;
window.runReport = function() {
  if (typeof oldRunReport === 'function') oldRunReport();
  atualizarKPIRelatoriosComFiltro();
}
</script>
      <div class="card">
        <div class="body">
          <div class="toolbar" style="margin-bottom:16px;gap:12px;">
            <button id="btnLimparDados" class="btn danger">Limpar todos os dados (exceto produtos)</button>
            <button id="btnLimparProdutos" class="btn danger">Limpar todos os produtos</button>
          </div>
          <canvas id="chart" height="160"></canvas>
          <div style="margin-top:12px">
            <table>
              <thead><tr><th>Produto</th><th class="right">Qtd</th><th class="right">Receita</th><th class="right">Lucro</th></tr></thead>
              <tbody id="reportTop"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Clientes -->
    <section id="clientes" hidden class="grid cols-2">
      <div class="card">
        <div class="head"><strong>Cadastrar cliente</strong></div>
        <div class="body">
          <div class="row">
            <div><label>Nome</label><input id="cName"></div>
            <div><label>Telefone</label><input id="cPhone" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="15"></div>
          </div>
          <div class="row">
            <div><label>E-mail</label><input id="cEmail"></div>
            <div><label>Documento</label><input id="cDoc" placeholder="CPF/CNPJ" maxlength="18"></div>
          </div>
          <button id="btnSaveCustomer" class="btn" style="margin-top:10px">Salvar</button>
        </div>
      </div>
      <div class="card">
        <div class="head"><strong>Lista de clientes</strong></div>
        <div class="body">
          <table>
            <thead><tr><th>Nome</th><th>Fone</th><th>E-mail</th><th>Doc</th><th></th></tr></thead>
            <tbody id="customersBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Configura√ß√µes -->
    <section id="config" hidden class="grid cols-2">
      <div class="card">
        <div class="head"><strong>Empresa & Cupom</strong></div>
        <div class="body">
          <div class="row">
            <div><label>Nome da empresa</label><input id="bName" placeholder="Guaran√° da Amaz√¥nia"></div>
            <div><label>Telefone</label><input id="bPhone" placeholder="(xx) xxxxx-xxxx"></div>
          </div>
          <div class="row">
            <div><label>Endere√ßo (para cupom)</label><input id="bAddr" placeholder="Rua, n¬∫ - Bairro - Cidade/UF"></div>
            <div><label>Mensagem de rodap√©</label><input id="bMsg" placeholder="Obrigado pela prefer√™ncia!"></div>
          </div>
          <div class="row">
            <div><label>Aliquota padr√£o de impostos (%)</label><input id="taxRate" type="number" step="0.01" value="0"></div>
            <div><label>Moeda</label>
              <select id="currency">
                <option value="BRL">BRL</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="head"><strong>Integra√ß√µes & Utilit√°rios</strong></div>
        <div class="body">
          <div class="toolbar">
            <button id="btnConnectPrinter2" class="btn ghost">Conectar impressora Bluetooth</button>
            <button id="btnTestPrint" class="btn secondary">Impress√£o de teste</button>
          </div>
          <p style="color:var(--muted);margin-top:8px">Dica: para impressoras ESC/POS BLE (caracter√≠stica 0xFFE1/0xFF02/NUS), use Chrome Android em HTTPS. Caso sua impressora use Bluetooth Cl√°ssico (SPP), utilize o bot√£o ‚ÄúImprimir cupom (sistema)‚Äù ap√≥s a venda ou o app do fabricante.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- √Årea de impress√£o (fallback via window.print) -->
  <div id="printArea" aria-hidden="true"></div>
  <!-- √Årea de cupom visual -->
  <div id="cupomVisual" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.7);z-index:99999;align-items:center;justify-content:center;">
    <div style="background:#fff;color:#222;padding:24px 32px;border-radius:16px;max-width:95vw;max-height:90vh;overflow:auto;box-shadow:0 8px 32px rgba(0,0,0,.25);">
      <div id="cupomVisualContent"></div>
      <div style="text-align:center;margin-top:18px"><button id="btnFecharCupom" class="btn secondary">Fechar</button></div>
    </div>
  </div>

  <!-- Chart.js para gr√°ficos (cacheado pelo SW) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
<script>
// Navega√ß√£o entre se√ß√µes do menu
document.addEventListener('DOMContentLoaded', function() {
  const navBtns = document.querySelectorAll('nav button[data-route]');
  const sections = document.querySelectorAll('main > section');
  navBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const route = btn.getAttribute('data-route');
      // Esconde todas as se√ß√µes
      sections.forEach(sec => sec.hidden = true);
      // Mostra a se√ß√£o correspondente
      const target = document.getElementById(route);
      if (target) target.hidden = false;
      // Atualiza aria-current
      navBtns.forEach(b => b.removeAttribute('aria-current'));
      btn.setAttribute('aria-current', 'page');
    });
  });
  // Mostra a primeira se√ß√£o por padr√£o
  if (sections.length) sections[0].hidden = false;
});

// Unifica funcionalidade do bot√£o "Impressora: desconectada" e "Conectar impressora Bluetooth"
document.addEventListener('DOMContentLoaded', function() {
  function conectarImpressoraBluetooth(printerStatus) {
    if (!printerStatus) return;
    if (printerStatus._isConnecting) return;
    printerStatus._isConnecting = true;
    printerStatus.textContent = 'üñ®Ô∏è Procurando dispositivos Bluetooth...';
    printerStatus.classList.remove('warn','success');
    printerStatus.classList.add('info');
    // Cria modal de sele√ß√£o
    let modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;';
    let box = document.createElement('div');
    box.style.cssText = 'background:#fff;padding:24px 18px;border-radius:12px;min-width:320px;max-width:95vw;max-height:80vh;overflow:auto;box-shadow:0 8px 32px rgba(0,0,0,.18);';
    box.innerHTML = '<h3 style="margin-top:0">Selecione um dispositivo Bluetooth</h3><div id="btList" style="margin:12px 0 0 0;min-height:40px">Buscando...</div><button id="btCancel" class="btn danger" style="margin-top:18px;width:100%">Cancelar</button>';
    modal.appendChild(box);
    document.body.appendChild(modal);
    const btList = box.querySelector('#btList');
    const btCancel = box.querySelector('#btCancel');
    btCancel.onclick = () => { document.body.removeChild(modal); printerStatus._isConnecting = false; printerStatus.textContent = 'üñ®Ô∏è Impressora: desconectada'; printerStatus.classList.remove('info','success'); printerStatus.classList.add('warn'); };
    (async () => {
      try {
        // Solicita dispositivo BLE (todos)
        const device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [0xFFE0, 0xFF02, 0xFF01, 0x1812, 0x180F, 'device_information']
        });
        btList.innerHTML = '';
        // Mostra o dispositivo encontrado
        let item = document.createElement('div');
        item.className = 'bt-device-item';
        item.style.cssText = 'padding:10px 8px;border:1px solid #eee;border-radius:7px;margin-bottom:8px;cursor:pointer;';
        item.innerHTML = `<b>${device.name || '(sem nome)'}</b><br><small>ID: ${device.id}</small>`;
        item.onclick = async () => {
          btList.innerHTML = 'Conectando...';
          try {
            let server = await device.gatt.connect();
            let service = null, characteristic = null;
            const services = await server.getPrimaryServices();
            for (let s of services) {
              try {
                const chars = await s.getCharacteristics();
                for (let c of chars) {
                  if (c.properties.write) {
                    service = s; characteristic = c; break;
                  }
                }
                if (characteristic) break;
              } catch {}
            }
            if (!characteristic) throw new Error('Impressora n√£o suportada ou n√£o encontrada.');
            printerStatus.textContent = 'üñ®Ô∏è Impressora: conectada';
            printerStatus.classList.remove('warn','info');
            printerStatus.classList.add('success');
            window.bluetoothPrinter = { device, server, service, characteristic };
            if (window.appFeedback) window.appFeedback('Impressora conectada com sucesso!');
            document.body.removeChild(modal);
            device.addEventListener('gattserverdisconnected', function() {
              printerStatus.textContent = 'üñ®Ô∏è Impressora: desconectada';
              printerStatus.classList.remove('success','info');
              printerStatus.classList.add('warn');
              if (window.appFeedback) window.appFeedback('Impressora desconectada. Clique para reconectar.');
            });
          } catch (e) {
            btList.innerHTML = '<span style="color:#c00">Erro ao conectar: ' + (e.message||e) + '</span>';
          } finally {
            printerStatus._isConnecting = false;
          }
        };
        btList.appendChild(item);
      } catch (e) {
        btList.innerHTML = '<span style="color:#c00">Nenhum dispositivo encontrado ou opera√ß√£o cancelada.</span>';
        printerStatus.textContent = 'üñ®Ô∏è Impressora: desconectada';
        printerStatus.classList.remove('success','info');
        printerStatus.classList.add('warn');
        if (window.appFeedback) window.appFeedback('Nenhum dispositivo encontrado.');
      } finally {
        printerStatus._isConnecting = false;
      }
    })();
  }
  // Bot√£o do topo
  const printerStatus = document.getElementById('printerStatus');
  if (printerStatus) {
    printerStatus.addEventListener('click', function() { conectarImpressoraBluetooth(printerStatus); });
  }
  // Bot√£o da tela de configura√ß√µes
  const btnConnectPrinter2 = document.getElementById('btnConnectPrinter2');
  if (btnConnectPrinter2) {
    btnConnectPrinter2.addEventListener('click', function() {
      const printerStatus = document.getElementById('printerStatus');
      conectarImpressoraBluetooth(printerStatus);
    });
  }
});
// Impress√£o de teste: exibe cupom visual de teste ao clicar no bot√£o
document.addEventListener('DOMContentLoaded', function() {
  const btnTestPrint = document.getElementById('btnTestPrint');
  const cupom = document.getElementById('cupomVisual');
  const cupomContent = document.getElementById('cupomVisualContent');
  const btnFecharCupom = document.getElementById('btnFecharCupom');
  if (btnTestPrint && cupom && cupomContent) {
    btnTestPrint.addEventListener('click', function() {
      let html = `<h2 style='text-align:center;margin-bottom:8px'>Cupom de Teste</h2>`;
      html += `<div style='margin-bottom:8px'>Data: <b>${new Date().toLocaleString('pt-BR')}</b></div>`;
      html += `<table style='width:100%;margin-bottom:8px'><thead><tr><th style='text-align:left'>Item</th><th style='text-align:right'>Qtd</th><th style='text-align:right'>Pre√ßo</th><th style='text-align:right'>Total</th></tr></thead><tbody>`;
      html += `<tr><td>Guaran√° Original 1L</td><td style='text-align:right'>2</td><td style='text-align:right'>R$ 10,00</td><td style='text-align:right'>R$ 20,00</td></tr>`;
      html += `<tr><td>Bolo de A√ßa√≠</td><td style='text-align:right'>1</td><td style='text-align:right'>R$ 8,00</td><td style='text-align:right'>R$ 8,00</td></tr>`;
      html += `</tbody></table>`;
      html += `<div style='text-align:right;font-size:18px;font-weight:bold;margin-bottom:8px'>TOTAL: R$ 28,00</div>`;
      html += `<div>Pagamento: <b>Dinheiro</b></div>`;
      html += `<div style='margin-top:12px;text-align:center;color:#888;font-size:13px'>Este √© um cupom de teste. Obrigado pela prefer√™ncia!</div>`;
      cupomContent.innerHTML = html;
      cupom.style.display = 'flex';
    });
    if (btnFecharCupom) btnFecharCupom.onclick = function() { cupom.style.display = 'none'; };
  }
});
</script>
<script>
// Exibe bot√£o de imprimir venda ap√≥s finalizar
document.addEventListener('DOMContentLoaded', function() {
  let ultimaVenda = null;
  const btnFinalizar = document.getElementById('btnFinalizar');
  const btnImprimir = document.getElementById('btnImprimirVenda');
  if (btnFinalizar && btnImprimir) {
    btnFinalizar.addEventListener('click', function() {
      // Aguarda venda ser registrada (deve ser feito no JS principal, aqui √© exemplo)
      setTimeout(function() {
        // Simula que a venda foi registrada e salva em ultimaVenda
        // No seu JS principal, atribua a venda real a ultimaVenda
        ultimaVenda = window.ultimaVenda || null;
        if (ultimaVenda) {
          btnImprimir.style.display = '';
        }
      }, 500);
    });
    btnImprimir.addEventListener('click', function() {
      if (!ultimaVenda) {
        alert('Nenhuma venda registrada para imprimir.');
        return;
      }
      // Exibe informa√ß√µes da venda (substitua por impress√£o real se desejar)
      let info = 'Venda registrada:\n';
      info += 'Data: ' + (new Date(ultimaVenda.at)).toLocaleString('pt-BR') + '\n';
      info += 'Itens:\n';
      ultimaVenda.items.forEach(function(item) {
        info += '- ' + item.name + ' x' + item.qty + ' = R$ ' + (item.price*item.qty).toFixed(2) + '\n';
      });
      info += 'Total: R$ ' + (ultimaVenda.total || 0).toFixed(2);
      alert(info);
    });
  }
});
</script>
<script>
// M√°scara de telefone brasileiro para o campo de telefone do cliente
document.addEventListener('DOMContentLoaded', function() {
  var tel = document.getElementById('cPhone');
  if (tel) {
    tel.addEventListener('input', function(e) {
      let v = this.value.replace(/\D/g, '');
      if (v.length > 11) v = v.slice(0, 11);
      if (v.length > 10) {
        v = v.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      } else if (v.length > 6) {
        v = v.replace(/(\d{2})(\d{4,5})(\d{0,4})/, '($1) $2-$3');
      } else if (v.length > 2) {
        v = v.replace(/(\d{2})(\d{0,5})/, '($1) $2');
      } else {
        v = v.replace(/(\d{0,2})/, '($1');
      }
      this.value = v.trim();
    });
  }

  // M√°scara de CNPJ para o campo de documento do cliente
  var cnpj = document.getElementById('cDoc');
  if (cnpj) {
    cnpj.addEventListener('input', function(e) {
      let v = this.value.replace(/\D/g, '');
      if (v.length > 14) v = v.slice(0, 14);
      if (v.length > 12) {
        v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2})/, '$1.$2.$3/$4-$5');
      } else if (v.length > 8) {
        v = v.replace(/(\d{2})(\d{3})(\d{3})(\d{0,4})/, '$1.$2.$3/$4');
      } else if (v.length > 5) {
        v = v.replace(/(\d{2})(\d{3})(\d{0,3})/, '$1.$2.$3');
      } else if (v.length > 2) {
        v = v.replace(/(\d{2})(\d{0,3})/, '$1.$2');
      }
      this.value = v;
    });
  }
});
</script>
</body>
</html>
